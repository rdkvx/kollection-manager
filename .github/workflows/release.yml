name: Release Deploy (Go App + Terraform Infra)

on:
  release:
    types: [published]

jobs:
  # üèóÔ∏è 1Ô∏è‚É£ Build + Push da imagem (autom√°tico)
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    env:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GAR_LOCATION: ${{ secrets.GAR_LOCATION }}
      GAR_REPOSITORY: ${{ secrets.GAR_REPOSITORY }}
      GKE_CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
      GKE_LOCATION: ${{ secrets.GKE_LOCATION }}
      TERRAFORM_REPO: ${{ secrets.TERRAFORM_REPO }}
      APP_PATH: apps/kollection-manager
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
      image_uri: ${{ steps.build.outputs.image_uri }}

    steps:
      - name: Checkout application repo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker $GAR_LOCATION-docker.pkg.dev --quiet

      - name: Build and push Docker image
        id: build
        run: |
          VERSION=${{ github.event.release.tag_name }}
          IMAGE_URI=$GAR_LOCATION-docker.pkg.dev/$GCP_PROJECT_ID/$GAR_REPOSITORY/kollection-manager:$VERSION
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI
          echo "image_tag=$VERSION" >> $GITHUB_OUTPUT
          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT

      - name: Checkout Terraform repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TERRAFORM_REPO }}
          token: ${{ secrets.GH_PERSONAL_TOKEN }}
          path: terraform-repo

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.7

      - name: Update image tag in Terraform values
        run: |
          sed -i "s|tag: .*|tag: ${{ steps.build.outputs.image_tag }}|" terraform-repo/${{ env.APP_PATH }}/values.yaml

      - name: Upload Terraform folder for next job
        uses: actions/upload-artifact@v4
        with:
          name: terraform-repo
          path: terraform-repo
          retention-days: 1

  # üöÄ 2Ô∏è‚É£ Deploy (requer aprova√ß√£o manual)
  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: https://console.cloud.google.com/kubernetes/deployment

    env:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GKE_CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
      GKE_LOCATION: ${{ secrets.GKE_LOCATION }}
      APP_PATH: apps/kollection-manager
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}

    steps:
      - name: Download Terraform repo
        uses: actions/download-artifact@v4
        with:
          name: terraform-repo
          path: terraform-repo

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.7

      - name: Configure kubectl (GKE)
        run: |
          gcloud container clusters get-credentials $GKE_CLUSTER_NAME \
            --region $GKE_LOCATION \
            --project $GCP_PROJECT_ID

      - name: Terraform Init
        run: terraform -chdir=terraform-repo/${{ env.APP_PATH }} init -input=false

      - name: Terraform Plan
        run: terraform -chdir=terraform-repo/${{ env.APP_PATH }} plan -out=tfplan -input=false

      - name: Terraform Apply (after approval)
        run: terraform -chdir=terraform-repo/${{ env.APP_PATH }} apply -auto-approve tfplan
